<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Split Marketing Sources</title>
    <style>
        /* Styles remain the same */
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; height: 300px; padding: 10px; font-family: monospace; font-size: 14px; box-sizing: border-box; margin-top: 10px; }
        button { padding: 10px 20px; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .format-selector { margin-bottom: 10px; }
        .format-selector label { margin-right: 15px; cursor: pointer; }
        .tables { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 30px; }
        table { border-collapse: collapse; width: 100%; max-width: 600px; margin-bottom: 20px; }
        th, td { border: 1px solid #cccccc; padding: 8px 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        caption { caption-side: top; font-weight: bold; margin-bottom: 5px; font-size: 18px; }
        @media (max-width: 650px) { .tables { flex-direction: column; } table { max-width: 100%; } }
    </style>
</head>
<body>

    <h1>Split Marketing Sources</h1>
    <p>Select input format, paste data, click Process. Check console (F12) for details.</p>

    <div class="format-selector">
        <strong>Select Input Format:</strong><br>
        <label>
            <input type="radio" name="inputFormat" value="ftp" checked> Pivot Table Format (e.g., <code>SourceKey 123</code>)
        </label>
        <br>
        <label>
            <input type="radio" name="inputFormat" value="cc"> Constant Contact Format (e.g., <code>Mktg Source: SourceKey 1,234 ...</code>)
        </label>
    </div>

    <textarea id="inputData" placeholder="Paste your raw list here..."></textarea>
    <br>
    <button onclick="processData()">Process</button>

    <div class="tables">
        <table id="otherMktgTable">
            <caption>OTHER MKTGSOURCES</caption>
            <thead><tr><th>Source</th><th>Count</th></tr></thead>
            <tbody></tbody>
        </table>
        <table id="mainMktgTable">
            <caption>Main Marketing Sources</caption>
            <thead><tr><th>Source</th><th>Count</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        function processData() {
            console.clear();
            console.log("Processing data...");

            const rawInput = document.getElementById('inputData').value.trim();
            if (!rawInput) { alert('Please paste the raw list.'); return; }

            const selectedFormat = document.querySelector('input[name="inputFormat"]:checked');
            if (!selectedFormat) { alert('Please select an input format.'); return; }
            const formatType = selectedFormat.value;
            console.log(`Selected format: ${formatType.toUpperCase()}`);

            const lines = rawInput.split('\n');
            const data = {}; // Stores data with keys EXACTLY as parsed from input

            const ccRegex = /^Mktg Source:\s*(\S+)\s+([\d,]+).*$/;
            const ftpRegex = /^(\S+)\s+(\d+)\s*$/; // Allows trailing spaces

            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;

                let match;
                let key = null;
                let countStr = null;
                let parseSuccess = false;

                if (formatType === 'cc') {
                    match = line.match(ccRegex);
                    if (match) { key = match[1]; countStr = match[2].replace(/,/g, ''); parseSuccess = true; }
                } else if (formatType === 'ftp') {
                    match = line.match(ftpRegex);
                    if (match) { key = match[1]; countStr = match[2]; parseSuccess = true; }
                }

                if (parseSuccess && key && countStr !== null) {
                    const count = parseInt(countStr, 10);
                    if (!isNaN(count)) {
                        data[key] = count; // Store using original key from input
                        // console.log(`Line ${index + 1}: Parsed OK (${formatType.toUpperCase()}) - Key: "${key}", Count: ${count}`); // Optional: uncomment for detailed parse log
                    } else {
                         console.warn(`Line ${index + 1}: Could not parse count for key "${key}" from string "${countStr}" in line: "${line}"`);
                    }
                } else {
                    console.warn(`Line ${index + 1}: FAILED to parse using ${formatType.toUpperCase()} format: "${line}"`);
                }
            });

            // --- Key Normalization Step ---
            // Map different input keys to the single key used in the final output list.
            console.log("Normalizing keys for output consistency...");

            // 1. Handle TPMain/TPMAIN (Case difference) -> Target: TPMain
            if (data["TPMAIN"] !== undefined && data["TPMain"] === undefined) {
                console.log(`   Mapping FTP key "TPMAIN" to output key "TPMain" (Value: ${data["TPMAIN"]})`);
                data["TPMain"] = data["TPMAIN"];
                delete data["TPMAIN"]; // Keep data tidy
            }

            // 2. Handle 7TGraham (FTP) vs 7Theresa (CC) -> Target: 7Theresa
            if (data["7TGraham"] !== undefined && data["7Theresa"] === undefined) {
                console.log(`   Mapping FTP key "7TGraham" to output key "7Theresa" (Value: ${data["7TGraham"]})`);
                data["7Theresa"] = data["7TGraham"];
                delete data["7TGraham"];
            } else if (data["7TGraham"] !== undefined && data["7Theresa"] !== undefined) {
                 console.warn(`   Both "7TGraham" (${data["7TGraham"]}) and "7Theresa" (${data["7Theresa"]}) found in parsed data. Using value from "7Theresa".`);
                 delete data["7TGraham"]; // Prioritize CC key if both somehow exist
            }

            // 3. Handle 4HomeShowOTH (FTP) vs 4HomeShowOther (CC) -> Target: 4HomeShowOther
             if (data["4HomeShowOTH"] !== undefined && data["4HomeShowOther"] === undefined) {
                console.log(`   Mapping FTP key "4HomeShowOTH" to output key "4HomeShowOther" (Value: ${data["4HomeShowOTH"]})`);
                data["4HomeShowOther"] = data["4HomeShowOTH"];
                delete data["4HomeShowOTH"];
            } else if (data["4HomeShowOTH"] !== undefined && data["4HomeShowOther"] !== undefined) {
                 console.warn(`   Both "4HomeShowOTH" (${data["4HomeShowOTH"]}) and "4HomeShowOther" (${data["4HomeShowOther"]}) found. Using value from "4HomeShowOther".`);
                 delete data["4HomeShowOTH"];
            }

             // 4. Handle 7OtherBenefits (Input) vs 7Other-Benefits (Output List) -> Target: 7Other-Benefits
             if (data["7OtherBenefits"] !== undefined && data["7Other-Benefits"] === undefined) {
                console.log(`   Mapping Input key "7OtherBenefits" to output key "7Other-Benefits" (Value: ${data["7OtherBenefits"]})`);
                data["7Other-Benefits"] = data["7OtherBenefits"];
                delete data["7OtherBenefits"];
            } else if (data["7OtherBenefits"] !== undefined && data["7Other-Benefits"] !== undefined) {
                 // This case means the input *already* had the hyphenated key, which is unlikely but possible.
                 console.warn(`   Both "7OtherBenefits" (${data["7OtherBenefits"]}) and "7Other-Benefits" (${data["7Other-Benefits"]}) found. Using value from "7Other-Benefits".`);
                 delete data["7OtherBenefits"]; // Remove the non-hyphenated one if both exist
            }
            console.log("Normalization complete. Populating tables...");
            // --- End Normalization ---


            // Define the EXACT order and keys for OTHER MKTGSOURCES (using the TARGET keys after normalization)
            const otherMktgSourcesOrder = [
                "1NeedsResearch", "1WalkIn", "2BNI", "2CoT", "2GeneralAdsOther",
                "2OtherBenefits", // This key exists in both inputs and doesn't need normalization from the user examples provided.
                "2OtherEvents", "2OtherNetworking", "2OtherNonProfit",
                "2ShipTourEvent", "2SocialMedia", "2VacayPerks", "3AlumniPastPrg",
                "4AirportEUG", "4AirportMFR", "4CruiseClick", "4CruiseNightEvent",
                "4HomeShowEUG", "4HomeShowOther", // Target key
                "4InternalOld", "4InternetNonProgram", "4ORContempTheatre", "4OtherEvents",
                "4OtherNetworking", "4OtherNonProfit", "4TheShedd", "4TUNNAA", "4TVRadio",
                "4WordofMouth", "5BrellaProductions", "7ACurtis", "7CDenley", "7DSoben",
                "7EButler", // Note: 7EGarrett from FTP is ignored as it's not in CC or this list
                "7Gary", "7KLawson", "7MBunner", "7MMeyi",
                "7Other-Benefits", // Target key
                "7PastEmployee", "7RPirwitz", "7RyanTaylor",
                "7Theresa", // Target key
                "8CherylRosen", "8FormerAssoc", "8NealAlyseTMGHandles", "8SKevins",
                "9InternalOld", "9OtherBenefits", "9Siemens", "9HQ",
                "TPMain" // Target key
            ];

            // Define the Main Marketing Sources
            const mainMktgMap = [ /* ... Same list as before ... */
                 { label: "AMAC",                 key: "1AMAC" }, { label: "Bells of the Cascades",key: "4BellsoftheCascades" },
                 { label: "CCNY",                 key: "3CityCollegeNYCCNY" }, { label: "Dlindberg",            key: "8DLindberg" },
                 { label: "Dmenkhaus",            key: "8DMenkhaus" }, { label: "FOP",                  key: "2FOP" },
                 { label: "Hcosta",               key: "8HCosta" }, { label: "LaneLeaders",          key: "1LaneLead" },
                 { label: "LifeBalance",          key: "1LifeBalance" }, { label: "Lnanakul",             key: "8LNanakul" },
                 { label: "MyEdDiscount",         key: "1MyEdDiscount" }, { label: "NPN",                  key: "4NPN" },
                 { label: "Oregon State",         key: "3OregonStateORST" }, { label: "Passport",             key: "1Passport" },
                 { label: "PGI",                  key: "2ProctorGallagher" }, { label: "PollinGroup",          key: "4Pollin" },
                 { label: "Rpunch",               key: "8RPunch" }, { label: "Shepherd Univ AA",     key: "3ShepherdUAASUAA" },
                 { label: "AlyseNeal",            key: "8AlyseNeal" }, { label: "UTSA",                 key: "3UTSanAntonioUTSA" },
                 { label: "WOAR",                 key: "2WOAR" }, { label: "YouDecide",            key: "1YouDecide" }
            ];

            // Populate the OTHER MKTGSOURCES table (Using the target keys from the list)
            const otherMktgTbody = document.querySelector('#otherMktgTable tbody');
            otherMktgTbody.innerHTML = '';
            otherMktgSourcesOrder.forEach(sourceKey => {
                // Lookup will now find the count using the TARGET key (e.g., "7Theresa")
                // because the normalization step potentially moved the value there.
                const count = data[sourceKey] !== undefined ? data[sourceKey] : 0;
                 if (data[sourceKey] === undefined) {
                     console.log(`   Lookup for "${sourceKey}" in final data failed (count set to 0).`);
                 }
                const row = document.createElement('tr');
                row.innerHTML = `<td>${sourceKey}</td><td>${count}</td>`;
                otherMktgTbody.appendChild(row);
            });

            // Populate the Main Marketing Sources table
            const mainMktgTbody = document.querySelector('#mainMktgTable tbody');
            mainMktgTbody.innerHTML = '';
            mainMktgMap.forEach(item => {
                // Check if these keys also need normalization if they differ between inputs
                const count = data[item.key] !== undefined ? data[item.key] : 0;
                const row = document.createElement('tr');
                row.innerHTML = `<td>${item.label}</td><td>${count}</td>`;
                mainMktgTbody.appendChild(row);
            });
            console.log("Processing finished.");
        }
    </script>

</body>
</html>